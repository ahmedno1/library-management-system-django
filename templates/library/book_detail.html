{% extends "base.html" %}
{% load static %}

{% block title %}{{ book.title }} | E-Library{% endblock %}

{% block content %}
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card h-100">
        {% if book.cover %}
          <img src="{{ book.cover.url }}" class="card-img-top" alt="{{ book.title }} cover">
        {% else %}
          <div class="book-cover d-flex align-items-center justify-content-center text-muted">
            <i class="bi bi-image fs-1"></i>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="col-lg-8">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <span class="badge text-bg-light">{{ book.category.name }}</span>
              <h1 class="h3 mt-2 mb-1">{{ book.title }}</h1>
                <p class="text-muted mb-2">
                  by <a href="{% url 'library:author_detail' book.author.pk %}">{{ book.author.full_name }}</a>
                </p>
            </div>
            <div>
              {% if book.available_copies > 0 %}
                <span class="badge text-bg-success">Available ({{ book.available_copies }})</span>
              {% else %}
                <span class="badge text-bg-danger">Unavailable</span>
              {% endif %}
            </div>
          </div>

          <div class="mb-3 d-flex align-items-center gap-2">
            {% if book.avg_rating %}
              <span class="rating-stars">
                {% for i in "12345" %}
                  {% with idx=forloop.counter %}
                    {% if book.avg_rating >= idx %}
                      <i class="bi bi-star-fill text-warning"></i>
                    {% elif book.avg_rating >= idx|add:'-0.5' %}
                      <i class="bi bi-star-half text-warning"></i>
                    {% else %}
                      <i class="bi bi-star text-secondary"></i>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </span>
              <strong>{{ book.avg_rating|floatformat:1 }}/5</strong>
              <small class="text-muted">({{ book.review_count }} reviews)</small>
            {% else %}
              <small class="text-muted">No ratings yet</small>
            {% endif %}
          </div>

          <div class="row mb-3">
            <div class="col-sm-6 col-md-4">
              <div class="text-muted small">Language</div>
              <div class="fw-semibold">{{ book.language|default:"—" }}</div>
            </div>
            <div class="col-sm-6 col-md-4">
              <div class="text-muted small">Year</div>
              <div class="fw-semibold">{{ book.publication_year|default:"—" }}</div>
            </div>
            <div class="col-sm-6 col-md-4">
              <div class="text-muted small">Pages</div>
              <div class="fw-semibold">{{ book.pages|default:"—" }}</div>
            </div>
          </div>

          <div class="mb-4">
            <span class="badge text-bg-secondary">Total copies: {{ book.total_copies }}</span>
          </div>

          {% if user.is_authenticated %}
            {% if already_borrowed %}
              <button class="btn btn-outline-secondary" type="button" disabled>Already borrowed</button>
            {% elif book.available_copies <= 0 %}
              <button class="btn btn-outline-secondary" type="button" disabled>No copies available</button>
            {% elif can_borrow %}
              <form method="post" action="{% url 'borrowing:borrow_book' book.pk %}">
                {% csrf_token %}
                <button class="btn btn-primary" type="submit">Borrow</button>
              </form>
            {% else %}
              <button class="btn btn-outline-secondary" type="button" disabled>Limit reached</button>
            {% endif %}
          {% else %}
            <a class="btn btn-outline-secondary" href="{% url 'accounts:login' %}?next={% url 'library:book_detail' book.pk %}">
              Login to borrow
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <section class="mt-4">
    <div class="card border-0 shadow-sm">
      <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div class="flex-grow-1">
          <h2 class="h5 mb-1">Your Review</h2>
          {% if user.is_authenticated %}
            {% if user_review %}
              <span class="badge text-bg-success">You already reviewed this book</span>
            {% elif can_review %}
              <span class="text-muted small">You returned this book. Rate it below.</span>
            {% else %}
              <span class="text-muted small">Return this book to leave a review.</span>
            {% endif %}
          {% else %}
            <span class="text-muted small">Login to leave a review.</span>
          {% endif %}
        </div>
        <div class="w-100">
          {% if user.is_authenticated %}
            {% if has_returned %}
              <form method="post" action="{% url 'reviews:add_review' book.pk %}" class="d-flex flex-column flex-lg-row align-items-lg-center gap-2 mb-0">
                {% csrf_token %}
                <div class="rating-input d-flex align-items-center gap-1" data-rating-group data-current="{{ user_review.stars|default:'0' }}">
                  {% for star in "12345" %}
                    <button type="button" class="btn btn-link p-0 star-icon text-secondary" data-index="{{ forloop.counter }}">
                      <i class="bi bi-star"></i>
                    </button>
                  {% endfor %}
                </div>
                <input type="hidden" name="stars" value="{{ user_review.stars|default:'0' }}">
                <textarea name="comment" rows="2" class="form-control flex-grow-1" placeholder="Share a quick thought (optional)">{{ user_review.comment|default_if_none:'' }}</textarea>
                <button class="btn btn-primary" type="submit">
                  {% if user_review %}Update review{% else %}Submit review{% endif %}
                </button>
              </form>
            {% else %}
              <span class="text-muted small">Return this book to review.</span>
            {% endif %}
          {% else %}
            <a class="btn btn-outline-secondary" href="{% url 'accounts:login' %}?next={% url 'library:book_detail' book.pk %}">Login to review</a>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <section class="mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5 mb-0">Reviews</h2>
      <small class="text-muted">{{ book.review_count }} total</small>
    </div>
    <div class="list-group list-group-flush">
      {% for review in reviews %}
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ review.user.get_full_name|default:review.user.username }}</div>
             <div class="rating-stars small">
                {% for i in "12345" %}
                  {% with idx=forloop.counter %}
                    {% if review.stars >= idx %}
                      <i class="bi bi-star-fill text-warning"></i>
                    {% elif review.stars >= idx|add:'-0.5' %}
                      <i class="bi bi-star-half text-warning"></i>
                    {% else %}
                      <i class="bi bi-star text-secondary"></i>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
            <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
          </div>
          {% if review.comment %}
            <p class="mb-0 mt-2">{{ review.comment }}</p>
          {% else %}
            <p class="mb-0 mt-2 text-muted">No comment provided.</p>
          {% endif %}
        </div>
      {% empty %}
        <div class="list-group-item text-muted">No reviews yet.</div>
      {% endfor %}
    </div>
  </section>
{% endblock %}



